<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fitness Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }
        
        /* Full-screen camera container */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }
        
        #canvas {
            display: none;
        }
        
        /* Overlay system */
        .overlay {
            position: fixed;
            width: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        .overlay * {
            pointer-events: auto;
        }
        
        /* Top status bar */
        .top-overlay {
            top: 0;
            padding: 50px 20px 20px 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .time {
            font-variant-numeric: tabular-nums;
        }
        
        .profile-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        /* Calorie progress bar */
        .calorie-progress {
            margin-top: 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 12px 16px;
            backdrop-filter: blur(10px);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .progress-title {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        
        .progress-numbers {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 62%; /* This will be dynamic */
        }
        
        /* Bottom card overlay */
        .bottom-overlay {
            bottom: 0;
            padding: 0 20px 40px 20px;
        }
        
        .info-card {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-card.visible {
            transform: translateY(0);
        }
        
        .card-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-content {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .nutrition-item {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .nutrition-value {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .nutrition-label {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Voice button */
        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px auto;
            font-size: 24px;
            color: white;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .voice-button:active {
            transform: scale(0.95);
            background: rgba(255,0,0,0.3);
        }
        
        .voice-button.listening {
            background: rgba(255,0,0,0.5);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Bottom navigation */
        .bottom-nav {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 16px 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s ease;
            user-select: none;
        }
        
        .nav-item.active {
            color: #4ade80;
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        /* Auth screen overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .auth-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
            color: #333;
        }
        
        .auth-button {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .auth-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .auth-link {
            text-align: center;
            margin-top: 15px;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        
        .auth-link a {
            color: white;
            text-decoration: none;
            font-weight: 600;
        }
        
        .hidden {
            display: none;
        }

        /* Profile grid styling */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .profile-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .profile-label {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .profile-value {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .logout-button {
            margin-top: 16px;
            padding: 12px 24px;
            background: rgba(255,0,0,0.2);
            border: 1px solid rgba(255,0,0,0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }
        
        /* Responsive adjustments */
        @media (max-height: 700px) {
            .top-overlay {
                padding: 40px 20px 15px 20px;
            }
            
            .voice-button {
                width: 70px;
                height: 70px;
                font-size: 20px;
            }
        }

        /* Profile page specific styles */
        .profile-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-section:last-of-type {
            border-bottom: none;
        }

        .section-title {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-avatar {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: white;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-email {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .goal-section {
            text-align: center;
        }

        .goal-label {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .goal-badge {
            display: inline-block;
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: capitalize;
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .auth-button.secondary {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .auth-button.danger {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .auth-button.danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-container">
            <div id="register-form">
                <h2 class="auth-title">Create Account</h2>
                <div class="form-group">
                    <input type="text" id="reg-username" class="form-input" placeholder="Username">
                </div>
                <div class="form-group">
                    <input type="number" id="reg-age" class="form-input" placeholder="Age">
                </div>
                <div class="form-group">
                    <select id="reg-sex" class="form-select">
                        <option value="">Select Sex Assigned at Birth</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" id="reg-height" class="form-input" placeholder="Height (cm)">
                </div>
                <div class="form-group">
                    <input type="number" id="reg-weight" class="form-input" placeholder="Weight (kg)">
                </div>
                <div class="form-group">
                    <select id="reg-goal" class="form-select">
                        <option value="lose_weight">Lose Weight</option>
                        <option value="gain_muscle">Gain Muscle</option>
                        <option value="maintain">Maintain</option>
                    </select>
                </div>
                <button id="register-btn" class="auth-button">Get Started</button>
                <div class="auth-link">
                    Already have an account? <a href="#" id="show-login">Sign In</a>
                </div>
            </div>
            
            <div id="login-form" class="hidden">
                <h2 class="auth-title">Welcome Back</h2>
                <div class="form-group">
                    <input type="text" id="login-username" class="form-input" placeholder="Username">
                </div>
                <button id="login-btn" class="auth-button">Sign In</button>
                <div class="auth-link">
                    No account? <a href="#" id="show-register">Create Account</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Page Overlay -->
        <div id="profile-overlay" class="auth-overlay hidden">
            <div class="auth-container">
                <h2 class="auth-title">Profile Settings</h2>
                
                <!-- Personal Information Section -->
                <div class="profile-section">
                    <h3 class="section-title">Personal Information</h3>
                    <div class="profile-avatar">
                        <div class="avatar-circle" id="profile-avatar">
                            <span id="avatar-initial">U</span>
                        </div>
                        <div class="profile-info">
                            <div class="profile-name" id="profile-username">username</div>
                            <div class="profile-email" id="profile-email">user@example.com</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fitness Profile Section -->
                <div class="profile-section">
                    <h3 class="section-title">Fitness Profile</h3>
                    <div class="profile-stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Age</div>
                            <div class="stat-value" id="profile-age">--</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Sex</div>
                            <div class="stat-value" id="profile-sex">--</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Height</div>
                            <div class="stat-value" id="profile-height">-- cm</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Weight</div>
                            <div class="stat-value" id="profile-weight">-- kg</div>
                        </div>
                    </div>
                    <div class="goal-section">
                        <div class="goal-label">Long-Term Goal</div>
                        <div class="goal-badge" id="profile-goal">maintain</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="profile-actions">
                    <button class="auth-button secondary" id="back-to-app">Back to App</button>
                    <button class="auth-button danger" id="logout-btn">Logout</button>
                </div>
            </div>
        </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <!-- Camera Background -->
        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <!-- Top Overlay -->
        <div class="overlay top-overlay">
            <div class="status-bar">
                <div class="time" id="current-time">10:26</div>
                <div class="profile-icon" id="profile-icon"></div>
            </div>
            <div class="calorie-progress">
                <div class="progress-header">
                    <span class="progress-title">Today's Calories</span>
                    <span class="progress-numbers" id="calorie-numbers">1,247 / 2,100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Overlay -->
        <div class="overlay bottom-overlay">
            <!-- Info Card (Dynamic Content) -->
            <div class="info-card" id="info-card">
                <div class="card-title" id="card-title">
                    Ready to Track
                </div>
                <div class="card-content" id="card-content">
                    Hold the mic button and say "analyze this food" or "log this food"
                </div>
            </div>
            
            <!-- Voice Button -->
            <div class="voice-button" id="voice-btn">
                🎤
            </div>
            
            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div class="nav-item active" data-tab="progress">
                    <div class="nav-icon">📊</div>
                    <div>Progress</div>
                </div>
                <div class="nav-item" data-tab="coach">
                    <div class="nav-icon">💪</div>
                    <div>Coach</div>
                </div>
                <div class="nav-item" data-tab="planner">
                    <div class="nav-icon">📅</div>
                    <div>Planner</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let stream;
        let lastAnalysisResult = null;
        let currentUser = null;
        let currentTab = 'coach';

        // DOM elements
        const authOverlay = document.getElementById('auth-overlay');
        const profileOverlay = document.getElementById('profile-overlay');
        const appContainer = document.getElementById('app-container');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const voiceBtn = document.getElementById('voice-btn');
        const infoCard = document.getElementById('info-card');
        const cardTitle = document.getElementById('card-title');
        const cardContent = document.getElementById('card-content');
        const currentTime = document.getElementById('current-time');
        const calorieNumbers = document.getElementById('calorie-numbers');
        const progressFill = document.getElementById('progress-fill');

        // API config
        const API_BASE = 'http://127.0.0.1:8000';

        // Initialize app
        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // Check for existing login
            const storedUser = localStorage.getItem('fitness-app-user');
            if (storedUser) {
                startApp(storedUser);
            }
            
            setupEventListeners();
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            currentTime.textContent = timeString;
        }

        function setupEventListeners() {
            // Auth form switching
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });

            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            });

            // Auth buttons
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('login-btn').addEventListener('click', handleLogin);

            // Voice button
            voiceBtn.addEventListener('touchstart', startRecording, { passive: true });
            voiceBtn.addEventListener('touchend', stopRecording);
            voiceBtn.addEventListener('mousedown', startRecording);
            voiceBtn.addEventListener('mouseup', stopRecording);

            // Navigation tabs
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });

            // Profile icon
            document.getElementById('profile-icon').addEventListener('click', showProfile);

            // Profile page buttons
            document.getElementById('back-to-app').addEventListener('click', hideProfile);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tab);
            });
            
            // Update card content based on tab
            updateCardForTab(tab);
        }

        function hideProfile() {
            profileOverlay.classList.add('hidden');
        }

        function handleLogout() {
            console.log('Logging out user:', currentUser);
            
            localStorage.removeItem('fitness-app-user');
            currentUser = null;
            lastAnalysisResult = null;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Hide all overlays and show auth
            profileOverlay.classList.add('hidden');
            authOverlay.classList.remove('hidden');
            appContainer.classList.add('hidden');
            
            // Reset forms
            document.getElementById('login-username').value = '';
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function updateCardForTab(tab) {
            switch(tab) {
                case 'progress':
                    showCard('Progress tab', 'Coming soon - Check your progress over time');
                    break;
                case 'coach':
                    showCard('Ready to Track', 'Hold the mic button and say "analyze this food" or "log this food"');
                    break;
                case 'planner':
                    showCard('Planner+', 'Coming soon - MCP powered meal planner, time scheduler, etc., to hit your goals');
                    break;
            }
        }


        function showCard(title, content, isFood = false) {
            cardTitle.textContent = title;
            
            if (isFood) {
                cardContent.innerHTML = content; // Allow HTML for nutrition grid
            } else {
                cardContent.textContent = content;
            }
            
            infoCard.classList.add('visible');
        }

        function hideCard() {
            infoCard.classList.remove('visible');
        }

        async function startApp(username) {
            currentUser = username.toLowerCase();
            localStorage.setItem('fitness-app-user', username);
            
            authOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            // Initialize to coach tab (middle button)
            switchTab('coach');
            
            await initCamera();
            await updateCalorieProgress();
        }

        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true 
                });
                video.srcObject = stream;
            } catch (err) {
                showCard('Camera Error', 'Camera access denied. Please enable camera permissions.');
            }
        }

        async function updateCalorieProgress() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/summary`, {
                    headers: { 'X-Username': currentUser }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    calorieNumbers.textContent = `${data.consumed_today} / ${data.target_calories}`;
                    
                    const percentage = (data.consumed_today / data.target_calories) * 100;
                    progressFill.style.width = Math.min(percentage, 100) + '%';
                }
            } catch (err) {
                console.error('Failed to update calorie progress:', err);
            }
        }

        // Voice recording functions
        async function startRecording() {
            if (isRecording) return;
            try {
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = processVoiceCommand;
                mediaRecorder.start();
                isRecording = true;
                voiceBtn.classList.add('listening');
                showCard('Listening...', 'Speak your command now');
            } catch (err) {
                showCard('Microphone Error', err.message);
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            mediaRecorder.stop();
            isRecording = false;
            voiceBtn.classList.remove('listening');
            showCard('Processing...', 'Analyzing your voice command');
        }

        async function processVoiceCommand() {
            if (!currentUser) return;
            try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice_command.webm');

                const response = await fetch(`${API_BASE}/voice_command`, {
                    method: 'POST',
                    headers: { 'X-Username': currentUser },
                    body: formData
                });

                const result = await response.json();
                
                switch (result.action) {
                    case 'log_food': await logFoodDirect(); break;
                    case 'analyze_food': await analyzeFood(); break;
                    case 'log_previous': await logPreviousItem(); break;
                    case 'get_summary': await updateCalorieProgress(); break;
                    default: 
                        showCard('Not Understood', result.message || "I didn't understand that. Try saying 'analyze this food' or 'log this food'");
                }
            } catch (err) {
                showCard('Processing Error', 'Voice processing failed. Please try again.');
            }
        }

        async function logFoodDirect() {
            try {
                showCard('Analyzing...', 'Taking photo and analyzing food');
                const photoBlob = await takePhoto();
                
                const formData = new FormData();
                formData.append('image', photoBlob, 'food.jpg');
                
                const response = await fetch(`${API_BASE}/log_food_direct`, {
                    method: 'POST',
                    headers: { 'X-Username': currentUser },
                    body: formData
                });
                
                const result = await response.json();
                showFoodResult(result, true);
                await updateCalorieProgress();
            } catch (err) {
                showCard('Error', 'Failed to log food. Please try again.');
            }
        }

        async function analyzeFood() {
            try {
                showCard('Analyzing...', 'Taking photo and analyzing food');
                const photoBlob = await takePhoto();
                
                const formData = new FormData();
                formData.append('image', photoBlob, 'food.jpg');
                
                const response = await fetch(`${API_BASE}/analyze_food`, {
                    method: 'POST',
                    headers: { 'X-Username': currentUser },
                    body: formData
                });
                
                const result = await response.json();
                lastAnalysisResult = result;
                showFoodResult(result, false);
            } catch (err) {
                showCard('Error', 'Failed to analyze food. Please try again.');
            }
        }

        function showFoodResult(result, logged) {
            const status = logged ? 'LOGGED' : 'IDENTIFIED';
            const statusIcon = logged ? '✅' : '🔍';
            const actionText = logged ? '' : 'Say "log it" to save this to your diary';
            
            const nutritionGrid = `
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <div class="nutrition-value">${result.calories}</div>
                        <div class="nutrition-label">calories</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value">25g</div>
                        <div class="nutrition-label">protein</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value">30g</div>
                        <div class="nutrition-label">carbs</div>
                    </div>
                </div>
                ${actionText ? `<div style="margin-top: 12px; color: #4ade80; font-size: 12px;">${actionText}</div>` : ''}
            `;

            showCard(`${statusIcon} ${status}: ${result.description.toUpperCase()}`, nutritionGrid, true);
        }

        async function logPreviousItem() {
            if (!lastAnalysisResult) {
                showCard('Nothing to Log', 'Please analyze a food item first');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/log_previous`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Username': currentUser
                    },
                    body: JSON.stringify({
                        type: lastAnalysisResult.description.split(' ')[0],
                        description: lastAnalysisResult.description,
                        calories: lastAnalysisResult.calories
                    })
                });
                
                showFoodResult(lastAnalysisResult, true);
                await updateCalorieProgress();
                lastAnalysisResult = null;
            } catch (err) {
                showCard('Error', 'Failed to log item. Please try again.');
            }
        }

        function takePhoto() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            return new Promise((resolve) => {
                canvas.toBlob(resolve, 'image/jpeg', 0.8);
            });
        }

        // Auth functions (simplified versions of your existing code)
        async function handleRegister() {
            const username = document.getElementById('reg-username').value.toLowerCase().trim();
            const age = document.getElementById('reg-age').value;
            const sex = document.getElementById('reg-sex').value;
            const height = document.getElementById('reg-height').value;
            const weight = document.getElementById('reg-weight').value;
            const goal = document.getElementById('reg-goal').value;

            if (!username || !age || !sex || !height || !weight) {
                alert('Please fill out all fields.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        username, age: parseInt(age), sex, 
                        height_cm: parseInt(height), 
                        weight_kg: parseInt(weight), goal 
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    startApp(result.username);
                } else {
                    const err = await response.json();
                    alert(`Registration failed: ${err.detail}`);
                }
            } catch (err) {
                alert('Registration error occurred.');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('login-username').value.toLowerCase().trim();
            if (!username) {
                alert('Please enter a username.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username })
                });

                if (response.ok) {
                    const result = await response.json();
                    startApp(result.username);
                } else {
                    alert('Login failed.');
                }
            } catch(err) {
                alert('Login error occurred.');
            }
        }

        async function showProfile() {
            if (!currentUser) return;
            
            showingProfile = true;
            profileOverlay.classList.remove('hidden');
            
            // Load profile data
            await loadProfileData();
        }

        function hideProfile() {
            showingProfile = false;
            profileOverlay.classList.add('hidden');
        }

        async function loadProfileData() {
            try {
                // For now, we'll use the summary endpoint to get some user data
                // and fill in placeholder data for the rest
                const response = await fetch(`${API_BASE}/summary`, {
                    headers: { 'X-Username': currentUser }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('profile-username').textContent = currentUser;
                    document.getElementById('profile-email').textContent = `${currentUser}@example.com`;
                    document.getElementById('profile-goal').textContent = data.goal?.replace('_', ' ') || 'maintain';
                    
                    // We'll need the actual profile endpoint for age, height, weight
                    document.getElementById('profile-age').textContent = '--';
                    document.getElementById('profile-height').textContent = '--';
                    document.getElementById('profile-weight').textContent = '--';
                } else {
                    // Handle error - maybe show placeholder data
                    document.getElementById('profile-username').textContent = currentUser;
                    document.getElementById('profile-email').textContent = `${currentUser}@example.com`;
                }
            } catch (err) {
                console.error('Failed to load profile data:', err);
                // Show placeholder data
                document.getElementById('profile-username').textContent = currentUser;
                document.getElementById('profile-email').textContent = `${currentUser}@example.com`;
            }
        }

        function handleProfileLogout() {
            // Reuse existing logout logic
            localStorage.removeItem('fitness-app-user');
            currentUser = null;
            showingProfile = false;
            
            authOverlay.classList.remove('hidden');
            appContainer.classList.add('hidden');
            profileOverlay.classList.add('hidden');
            
            if(stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        function handleLogout() {
            console.log('Logging out user:', currentUser);
            
            localStorage.removeItem('fitness-app-user');
            currentUser = null;
            lastAnalysisResult = null;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            authOverlay.classList.remove('hidden');
            appContainer.classList.add('hidden');
            
            // Reset forms and show login
            document.getElementById('login-username').value = '';
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        async function showProfile() {
            if (!currentUser) return;
            
            console.log('Profile icon clicked, showing profile page...');
            
            try {
                // Show profile overlay
                profileOverlay.classList.remove('hidden');
                
                // Fetch and populate profile data
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: { 'X-Username': currentUser }
                });
                
                if (response.ok) {
                    const profileData = await response.json();
                    console.log('Profile data received:', profileData);
                    
                    // Populate profile fields
                    document.getElementById('profile-username').textContent = profileData.username;
                    document.getElementById('profile-email').textContent = `${profileData.username}@example.com`;
                    document.getElementById('profile-age').textContent = profileData.age;
                    document.getElementById('profile-sex').textContent = profileData.sex;
                    document.getElementById('profile-height').textContent = `${profileData.height_cm} cm`;
                    document.getElementById('profile-weight').textContent = `${profileData.weight_kg} kg`;
                    document.getElementById('profile-goal').textContent = profileData.goal.replace('_', ' ');
                    
                    
                    // Set avatar initial
                    document.getElementById('avatar-initial').textContent = profileData.username.charAt(0).toUpperCase();
                } else {
                    console.error('Failed to fetch profile:', response.status);
                    // Show with placeholder data
                    document.getElementById('profile-username').textContent = currentUser;
                    document.getElementById('avatar-initial').textContent = currentUser.charAt(0).toUpperCase();
                }
            } catch (err) {
                console.error('Profile fetch error:', err);
                // Show with placeholder data
                document.getElementById('profile-username').textContent = currentUser;
                document.getElementById('avatar-initial').textContent = currentUser.charAt(0).toUpperCase();
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>